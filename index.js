// === ElleBot Office (Thai only, max sass) ===
// - ‡∏ö‡∏∏‡∏Ñ‡∏•‡∏¥‡∏Å: ‡πÄ‡∏£‡∏¥‡πà‡∏î ‡∏ï‡∏•‡∏Å ‡∏Å‡∏ß‡∏ô ‡∏à‡∏¥‡∏Å‡∏Å‡∏±‡∏î‡πÑ‡∏î‡πâ (‡∏õ‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÑ‡∏î‡πâ)
// - ‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å Newton / Tyra / Dream / Jisak
// - Auto webhook/polling + ‡πÑ‡∏°‡πà‡∏•‡πâ‡∏°‡∏á‡πà‡∏≤‡∏¢
const express = require("express");
const TelegramBot = require("node-telegram-bot-api");

const TOKEN = process.env.TELEGRAM_TOKEN || "";
const PUBLIC_URL = (process.env.PUBLIC_URL || "").replace(/\/+$/, "");
const PORT = process.env.PORT || 10000;

const app = express();
app.use(express.json());

// -------- Utils --------
const pick = (arr) => arr[Math.floor(Math.random() * arr.length)];
const timeGreeting = () => {
  const h = new Date().getHours();
  if (h < 5) return "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ô‡∏≠‡∏ô‡∏≠‡∏µ‡∏Å‡πÄ‡∏´‡∏£‡∏≠‡∏Ñ‡∏∞ ‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡πÉ‡∏ï‡πâ‡∏ï‡∏≤‡∏î‡∏≥‡πÑ‡∏°‡πà‡∏™‡∏ß‡∏¢‡∏ô‡∏∞ üòå";
  if (h < 12) return "‡∏≠‡∏£‡∏∏‡∏ì‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏¥‡πå‡πÅ‡∏°‡πà‡∏™‡∏≤‡∏ß‡∏≠‡∏≠‡∏ü‡∏ü‡∏¥‡∏® ‚òÄÔ∏è ‡∏•‡∏¥‡∏õ‡πÅ‡∏ô‡πà‡∏ô‡∏¢‡∏±‡∏á";
  if (h < 18) return "‡∏ö‡πà‡∏≤‡∏¢‡∏ô‡∏µ‡πâ‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡∏≠‡∏µ‡∏Å‡∏Å‡∏µ‡πà‡∏´‡πâ‡∏≠‡∏á‡∏Ñ‡∏∞‡∏•‡∏π‡∏Å üòµ‚Äçüí´";
  return "‡πÄ‡∏¢‡πá‡∏ô‡∏ô‡∏µ‡πâ‡∏Å‡∏¥‡∏ô‡∏≠‡∏∞‡πÑ‡∏£‡∏î‡∏µ‡∏Ñ‡∏∞‚Äî‡∏ô‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏î‡∏£‡∏≤‡∏°‡πà‡∏≤ üòè";
};

// -------- Persona bank (‡πÑ‡∏ó‡∏¢‡∏•‡πâ‡∏ß‡∏ô) --------
const generalGentle = [
  "‡πÅ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏à‡πâ‡∏∞ ‡πÉ‡∏à‡πÄ‡∏¢‡πá‡∏ô ‡πÜ ‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏à‡∏±‡∏î‡πÉ‡∏´‡πâ",
  "‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢‡∏Å‡πá‡∏û‡∏±‡∏Å ‡πÅ‡∏ï‡πà‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏±‡∏á‡∏≠‡∏¢‡πà‡∏≤‡πÉ‡∏´‡πâ‡∏ï‡∏Å ‚ú®",
  "‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡πÅ‡∏°‡πà‡∏ä‡πà‡∏ß‡∏¢‡∏Ñ‡∏¥‡∏î‡∏ó‡∏≤‡∏á‡∏≠‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏ô‡∏∞‡∏Ñ‡∏∞",
  "‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏™‡∏ß‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡∏ô‡∏¥‡∏î‡∏ô‡∏∂‡∏á‡∏û‡∏≠‡∏´‡∏≠‡∏°‡∏õ‡∏≤‡∏Å‡∏´‡∏≠‡∏°‡∏Ñ‡∏≠ üíÖ",
];

const generalSassy = [
  "‡∏á‡∏≤‡∏ô‡∏•‡πâ‡∏ô‡∏°‡∏∑‡∏≠‡πÅ‡∏ï‡πà‡∏•‡∏¥‡∏õ‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏î‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡πà‡∏∞",
  "‡∏î‡∏≤‡∏£‡πå‡∏Å‡∏´‡∏ô‡πà‡∏≠‡∏¢‡πÅ‡∏ï‡πà‡πÉ‡∏à‡∏î‡∏µ‡∏ô‡∏∞‡∏Ñ‡∏∞ ‡∏≠‡∏¢‡πà‡∏≤‡∏°‡∏≤‡∏´‡∏°‡∏¥‡πà‡∏ô‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏ü‡∏≤‡∏î‡πÄ‡∏ö‡∏≤ ‡πÜ",
  "‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î‡∏ó‡∏≥‡πÑ‡∏°‡∏Ñ‡∏∞ ‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡πÅ‡∏°‡πà‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‚Äî‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏î",
  "‡πÉ‡∏Ñ‡∏£‡πÅ‡∏£‡∏á‡πÑ‡∏î‡πâ ‡πÅ‡∏°‡πà‡∏Å‡πá‡πÅ‡∏£‡∏á‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà‡∏°‡∏µ‡∏Ñ‡∏•‡∏≤‡∏™‡∏Å‡∏ß‡πà‡∏≤ üòå",
];

const generalSpicy = [
  "‡∏≠‡∏¢‡πà‡∏≤‡∏°‡∏≤‡∏ó‡∏≥‡∏õ‡∏≤‡∏Å‡∏î‡∏µ‡∏ô‡∏∞‡∏Ñ‡∏∞ ‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡πÅ‡∏°‡πà‡∏î‡∏∏‡πÅ‡∏ö‡∏ö‡∏°‡∏µ‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏ä‡∏¥‡∏á üòò",
  "‡∏á‡∏≤‡∏ô‡∏Å‡∏≠‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏†‡∏π‡πÄ‡∏Ç‡∏≤ ‡πÅ‡∏ï‡πà‡∏Ñ‡∏¥‡πâ‡∏ß‡∏ï‡πâ‡∏≠‡∏á‡∏ü‡∏π‡∏ü‡πà‡∏≠‡∏á‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô",
  "‡∏ñ‡πâ‡∏≤‡∏à‡∏∞‡πÄ‡∏ó ‡πÅ‡∏°‡πà‡∏Å‡πá‡πÄ‡∏ó‡∏Å‡∏•‡∏±‡∏ö‡πÅ‡∏ö‡∏ö‡πÅ‡∏û‡∏á ‡πÜ ‡πÑ‡∏î‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô",
  "‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢‡∏ô‡∏±‡∏Å‡∏Å‡πá‡∏ã‡∏ö‡πÑ‡∏´‡∏•‡πà‡πÅ‡∏°‡πà‚Ä¶‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡πá‡πÑ‡∏õ‡∏•‡∏∏‡∏¢‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡∏à‡πâ‡∏∞ üòè",
];

// ‡∏ß‡∏á‡πÉ‡∏ô
const bank = {
  Newton: {
    keys: [/newton/i, /‡∏ô‡∏¥‡∏ß‡∏ï‡∏±‡∏ô/i],
    gentle: [
      "Newton ‡∏Ç‡∏≥‡πÄ‡∏Å‡πà‡∏á‡∏ô‡∏∞ ‡πÅ‡∏ï‡πà‡∏û‡∏∂‡πà‡∏á‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡∏π‡πà ‡∏ô‡πà‡∏≤‡∏£‡∏±‡∏Å‡πÅ‡∏´‡∏•‡∏∞",
      "‡∏û‡∏π‡∏î‡∏ñ‡∏∂‡∏á Newton ‡πÅ‡∏•‡πâ‡∏ß‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏Å‡∏≤‡∏®‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô‡∏ó‡∏∏‡∏Å‡∏ó‡∏µ",
    ],
    sassy: [
      "Newton ‡∏Å‡∏ß‡∏ô‡∏ï‡∏µ‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏á‡∏≤‡∏ô‡∏≠‡∏î‡∏¥‡πÄ‡∏£‡∏Å ‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏à‡∏∞‡πÄ‡∏´‡∏á‡∏≤‡∏°‡∏≤‡∏Å üòÇ",
      "‡∏ô‡∏¥‡∏ß‡∏ï‡∏±‡∏ô‡∏ô‡∏µ‡πà‡πÑ‡∏≠‡πÄ‡∏î‡∏µ‡∏¢‡∏û‡∏∏‡πà‡∏á‡πÅ‡∏£‡∏á ‡πÅ‡∏ï‡πà‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏î‡∏µ ‡πÜ ‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡πà‡∏∞",
    ],
    spicy: [
      "Newton ‡∏≠‡∏¢‡πà‡∏≤‡∏Å‡∏ß‡∏ô‡∏°‡∏≤‡∏Å ‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡πÅ‡∏°‡πà‡∏ü‡∏≤‡∏î‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏î‡∏î‡πÑ‡∏•‡∏ô‡πå‡∏ô‡∏∞‡∏Ñ‡∏∞ üòò",
      "‡πÉ‡∏Ñ‡∏£‡∏Å‡πà‡∏≠‡∏î‡∏£‡∏≤‡∏°‡πà‡∏≤‚Ä¶‡∏≠‡∏∏‡πä‡∏¢ ‡πÄ‡∏ú‡∏•‡∏≠‡∏Ñ‡∏¥‡∏î‡∏ñ‡∏∂‡∏á Newton ‡∏≠‡∏µ‡∏Å‡∏•‡∏∞ üòè",
    ],
  },
  Tyra: {
    keys: [/tyra/i, /‡∏ó‡∏µ‡∏£‡πà‡∏≤/i],
    gentle: [
      "Tyra ‡∏™‡∏ß‡∏¢‡πÅ‡∏•‡∏∞‡πÉ‡∏à‡∏î‡∏µ ‡∏á‡∏≤‡∏ô‡πÄ‡∏ô‡∏µ‡πä‡∏¢‡∏ö‡∏°‡∏≤‡∏Å",
      "‡∏ñ‡πâ‡∏≤ Tyra ‡πÇ‡∏≠‡πÄ‡∏Ñ ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡πÅ‡∏•‡πâ‡∏ß‡∏à‡πâ‡∏∞",
    ],
    sassy: [
      "‡∏ó‡∏µ‡∏£‡πà‡∏≤‡∏°‡∏≤‡∏≠‡∏ß‡∏¢‡∏≠‡∏µ‡∏Å‡∏•‡∏∞ ‡∏£‡∏≥‡∏Ñ‡∏≤‡∏ç‡πÅ‡∏ï‡πà‡∏Å‡∏π‡∏Å‡πá‡∏ä‡∏≠‡∏ö ü§≠",
      "Tyra ‡∏Ñ‡∏∑‡∏≠‡∏Ñ‡∏±‡∏î‡∏Å‡∏£‡∏≠‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏±‡∏á ‡∏ù‡∏∏‡πà‡∏ô‡∏à‡∏±‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Ñ‡πà‡∏∞",
    ],
    spicy: [
      "Tyra ‡∏ñ‡πâ‡∏≤‡∏à‡∏∞‡∏ä‡∏°‡∏Å‡πá‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏≤‡∏î‡πâ‡∏ß‡∏¢ ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡πà‡∏≤‡∏≠‡∏¥‡∏ô üòå",
      "‡∏û‡∏π‡∏î‡∏ñ‡∏∂‡∏á Tyra ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏¢‡∏Å‡∏•‡∏¥‡∏ï‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡πÄ‡∏™‡∏°‡∏≠ üíÖ",
    ],
  },
  Dream: {
    keys: [/dream/i, /‡∏î‡∏£‡∏µ‡∏°/i],
    gentle: [
      "‡∏î‡∏£‡∏µ‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏ô‡∏≤‡∏á‡∏ü‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ó‡∏µ‡∏°‡∏à‡∏£‡∏¥‡∏á ‡πÜ ü´∂",
      "‡∏ï‡∏¥‡∏î‡∏ï‡∏£‡∏á‡πÑ‡∏´‡∏ô‡∏ö‡∏≠‡∏Å Dream ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ ‡∏°‡∏ô‡∏∏‡∏©‡∏¢‡πå‡∏ã‡∏±‡∏û‡∏û‡∏≠‡∏£‡πå‡∏ï‡∏ï‡∏±‡∏ß‡∏ó‡πá‡∏≠‡∏õ",
    ],
    sassy: [
      "Dream ‡∏°‡∏≤‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏´‡∏£‡πà ‡∏á‡∏≤‡∏ô‡∏ô‡∏¥‡πà‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ô‡∏±‡πâ‡∏ô",
      "‡∏î‡∏£‡∏µ‡∏°‡∏Ñ‡∏∑‡∏≠ Soft Power ‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡∏°‡∏ï‡∏±‡∏ß‡∏à‡∏£‡∏¥‡∏á",
    ],
    spicy: [
      "Dream ‡∏≠‡∏¢‡πà‡∏≤‡πÉ‡∏à‡∏î‡∏µ‡πÄ‡∏Å‡∏¥‡∏ô ‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏Ñ‡∏ô‡πÄ‡∏Ñ‡∏¢‡∏ï‡∏±‡∏ß‡∏ô‡∏∞‡∏Ñ‡∏∞ üòâ",
      "‡πÉ‡∏´‡πâ‡∏î‡∏£‡∏µ‡∏°‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡πá‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ç‡∏≠‡∏á‡∏Å‡∏¥‡∏ô‡πÅ‡∏•‡∏Å‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏™‡∏¥ üç∞",
    ],
  },
  Jisak: {
    keys: [/jisak/i, /‡∏à‡∏µ‡∏ã‡∏±‡∏Ñ/i, /‡∏à‡∏µ‡∏ã‡∏±‡∏Å/i],
    gentle: [
      "‡∏à‡∏µ‡∏ã‡∏±‡∏Ñ‡πÄ‡∏á‡∏µ‡∏¢‡∏ö ‡πÜ ‡πÅ‡∏ï‡πà‡∏™‡∏Å‡∏¥‡∏•‡πÅ‡∏ô‡πà‡∏ô‡∏°‡∏≤‡∏Å‡∏ô‡∏∞",
      "Jisak ‡πÑ‡∏°‡πà‡∏Ñ‡πà‡∏≠‡∏¢‡∏û‡∏π‡∏î ‡πÅ‡∏ï‡πà‡∏á‡∏≤‡∏ô‡∏™‡∏ß‡∏¢‡πÄ‡∏™‡∏°‡∏≠",
    ],
    sassy: [
      "‡∏à‡∏µ‡∏ã‡∏±‡∏Ñ‡∏ï‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏á‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡πà‡∏≤‡∏õ‡∏≤‡∏Å‡∏ô‡∏∞‡∏Ñ‡∏∞ ‡∏£‡∏∞‡∏ß‡∏±‡∏á‡πÉ‡∏à‡∏™‡∏±‡πà‡∏ô üò≥",
      "‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏≤‡∏•‡∏∞‡∏´‡∏≤‡∏¢‡∏ï‡∏±‡∏ß‚Äî‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏à‡∏µ‡∏ã‡∏±‡∏Ñ‡πÄ‡∏Ñ‡πâ‡∏≤‡πÅ‡∏´‡∏•‡∏∞ üòÇ",
    ],
    spicy: [
      "Jisak ‡∏ñ‡πâ‡∏≤‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡πÅ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ ‡πÅ‡∏°‡πà‡∏à‡∏∞‡∏™‡πà‡∏á‡πÉ‡∏ö‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏•‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏∞ üòå",
      "‡∏à‡∏µ‡∏ã‡∏±‡∏Ñ‡∏à‡πâ‡∏≤ ‡∏≠‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏ï‡∏≠‡∏ö‡∏î‡πâ‡∏ß‡∏¢ ‡∏≠‡∏¢‡πà‡∏≤‡∏ó‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏á‡∏µ‡∏¢‡∏ö‡∏™‡∏≤‡∏¢‡πÄ‡∏ô‡∏µ‡∏¢‡∏ô",
    ],
  },
};

// ‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏ô‡∏ï‡πå‡∏¢‡∏≠‡∏î‡∏Æ‡∏¥‡∏ï
const intents = [
  {
    test: /(‡∏ó‡∏≥‡πÑ‡∏£|‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£|‡∏≠‡∏¢‡∏π‡πà‡πÑ‡∏´‡∏ô|‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå|‡∏ó‡∏±‡∏Å|hi|hello)/i,
    gentle: [
      "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏≠‡∏ö‡πÅ‡∏ä‡∏ï‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏á‡∏î‡∏á‡∏≤‡∏°‡∏≠‡∏¢‡∏π‡πà‡∏Ñ‡πà‡∏∞ ‚ú®",
      "‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏µ‡πà‡∏à‡πâ‡∏≤ ‡πÉ‡∏à‡πÄ‡∏¢‡πá‡∏ô ‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡πÅ‡∏°‡πà‡∏°‡∏≤‡∏Ñ‡πà‡∏∞",
    ],
    sassy: [
      "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏ß‡∏¢‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏î‡πâ‡∏≠ ‡∏á‡∏≤‡∏ô‡∏£‡∏≠‡πÑ‡∏î‡πâ‡∏™‡∏≠‡∏á‡∏ß‡∏¥ üòå",
      "‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ò‡∏≠‡∏Ñ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞ üíÖ",
    ],
    spicy: [
      "‡∏≠‡∏¢‡∏≤‡∏Å‡πÑ‡∏î‡πâ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÄ‡∏£‡πá‡∏ß ‡πÜ ‡∏Å‡πá‡∏≠‡∏¢‡πà‡∏≤‡∏ó‡∏±‡∏Å‡∏ã‡πâ‡∏≠‡∏ô‡∏™‡∏¥‡∏ö‡∏ä‡πà‡∏≠‡∏á‡∏ô‡∏∞‡∏Ñ‡∏∞ üòò",
      "‡∏°‡∏≤‡πÄ‡∏•‡∏¢‡∏à‡πâ‡∏∞ ‡πÅ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏õ‡∏±‡πâ‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏¥‡πà‡∏î",
    ],
  },
  {
    test: /(‡∏Å‡∏¥‡∏ô‡∏Ç‡πâ‡∏≤‡∏ß|‡∏Å‡∏¥‡∏ô‡∏¢‡∏±‡∏á|‡∏´‡∏¥‡∏ß|‡∏Å‡∏≤‡πÅ‡∏ü)/i,
    gentle: [
      "‡∏Å‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏∞ ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡∏´‡∏¥‡∏ß‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏≠‡∏¢‡∏π‡πà üòã",
      "‡∏¢‡∏±‡∏á‡πÄ‡∏•‡∏¢ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡∏ä‡∏ß‡∏ô‡πÄ‡∏ò‡∏≠‡πÑ‡∏õ‡∏Å‡∏¥‡∏ô‡∏û‡∏≠‡∏î‡∏µ",
    ],
    sassy: [
      "‡∏Å‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏≤‡∏Å‡∏Å‡∏¥‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡∏≠‡∏µ‡∏Å‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏Ñ‡πà‡∏∞ üòè",
      "‡∏Å‡∏≤‡πÅ‡∏ü‡πÅ‡∏Å‡πâ‡∏ß‡∏ô‡∏∂‡∏á‡∏Å‡∏±‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏à‡∏™‡∏≠‡∏á‡∏ä‡πâ‡∏≠‡∏ô‡πÇ‡∏ï‡πä‡∏∞ ‡∏à‡∏±‡∏î‡∏Ñ‡πà‡∏∞",
    ],
    spicy: [
      "‡∏´‡∏¥‡∏ß‡∏°‡∏≤‡∏Å ‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô ‡πÅ‡∏°‡πà‡∏á‡∏î‡∏Ñ‡∏∏‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏∞ üç∞",
      "‡∏Å‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß‚Äî‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏Å‡∏¥‡∏ô‡∏Ñ‡∏ô‡∏õ‡∏≤‡∏Å‡πÄ‡∏Å‡πà‡∏á‡∏Ñ‡πà‡∏∞ üòò",
    ],
  },
  {
    test: /(‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢|‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î|‡∏ó‡πâ‡∏≠|‡πÄ‡∏®‡∏£‡πâ‡∏≤|‡∏£‡πâ‡∏≠‡∏á‡πÑ‡∏´‡πâ)/i,
    gentle: [
      "‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢‡∏Å‡πá‡∏û‡∏±‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡πà‡∏∞ ‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡πÅ‡∏°‡πà‡∏Ñ‡πà‡∏≠‡∏¢‡∏î‡∏±‡∏ô‡∏ï‡πà‡∏≠‡πÉ‡∏´‡πâ",
      "‡∏Å‡∏≠‡∏î‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏ó‡∏µ ‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏∏‡∏¢‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ",
    ],
    sassy: [
      "‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢‡∏Å‡πá‡∏û‡∏±‡∏Å ‡πÅ‡∏ï‡πà‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏±‡∏á‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏µ‡∏û‡πÑ‡∏ß‡πâ ‚ú®",
      "‡∏£‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡πÄ‡∏ä‡πá‡∏î‡∏°‡∏≤‡∏™‡∏Ñ‡∏≤‡∏£‡πà‡∏≤‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡πÄ‡∏•‡∏≠‡∏∞",
    ],
    spicy: [
      "‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏õ‡∏±‡∏á‡∏ï‡πà‡∏≠‡∏Ñ‡πà‡∏∞ ‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡πÑ‡∏°‡πà‡∏ä‡πà‡∏ß‡∏¢‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡∏ô‡∏∞",
      "‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà‡∏´‡πâ‡∏≤‡∏°‡πÇ‡∏ó‡∏£.‡∏´‡∏≤‡πÅ‡∏ü‡∏ô‡πÄ‡∏Å‡πà‡∏≤‚Äî‡πÅ‡∏°‡πà‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï üòå",
    ],
  },
];

// ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ã‡πà‡∏ö (‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô: sassy)
let MODE = "sassy"; // "gentle" | "sassy" | "spicy"

// ‡∏™‡∏∏‡πà‡∏°‡∏ï‡∏≤‡∏°‡πÇ‡∏´‡∏°‡∏î
function fromMode(gentle, sassy, spicy) {
  if (MODE === "gentle") return pick(gentle);
  if (MODE === "spicy") return pick(spicy);
  return pick(sassy);
}

function replyGeneral() {
  return fromMode(generalGentle, generalSassy, generalSpicy);
}

function replyIntent(text) {
  for (const it of intents) {
    if (it.test.test(text)) return fromMode(it.gentle, it.sassy, it.spicy);
  }
  return null;
}

function replyPeople(text) {
  const lower = text.toLowerCase();
  for (const name in bank) {
    const p = bank[name];
    if (p.keys.some((re) => re.test(lower))) {
      return fromMode(p.gentle, p.sassy, p.spicy);
    }
  }
  return null;
}

// -------- Boot & handlers --------
let bot = null;

async function startWebhook() {
  bot = new TelegramBot(TOKEN, { polling: false });
  app.post(`/webhook/${TOKEN}`, (req, res) => {
    bot.processUpdate(req.body);
    res.sendStatus(200);
  });
  const url = `${PUBLIC_URL}/webhook/${TOKEN}`;
  let delay = 3000;
  for (let i = 1; i <= 5; i++) {
    try {
      await bot.setWebHook(url);
      console.log("‚úÖ Webhook set:", url);
      break;
    } catch (e) {
      console.warn(`setWebHook attempt ${i} failed:`, e?.message || e);
      await new Promise((r) => setTimeout(r, delay));
      delay *= 2;
    }
  }
}

async function startPolling() {
  try {
    const fetch = (await import("node-fetch")).default;
    await fetch(`https://api.telegram.org/bot${TOKEN}/deleteWebhook`);
  } catch (_) {}
  bot = new TelegramBot(TOKEN, { polling: true });
  console.log("‚úÖ Polling started");
}

function attachHandlers() {
  if (!bot) return;

  bot.onText(/^\/start$/i, (msg) => {
    bot.sendMessage(
      msg.chat.id,
      `ElleBot Office ‡∏°‡∏≤‡∏à‡πâ‡∏≤ üíÖ\n‚Ä¢ ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏•‡πâ‡∏ß‡∏ô\n‚Ä¢ ‡πÇ‡∏´‡∏°‡∏î‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ: ${MODE}\n‚Ä¢ ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á: /mode gentle|sassy|spicy, /vibe, /help\n\n${timeGreeting()}`
    );
  });

  bot.onText(/^\/help$/i, (msg) => {
    bot.sendMessage(
      msg.chat.id,
      "‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏°‡∏µ‡∏î‡∏±‡∏á‡∏ô‡∏µ‡πâ‡∏à‡πâ‡∏≤:\n" +
        "‚Ä¢ /mode gentle|sassy|spicy ‚Äî ‡∏õ‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ã‡πà‡∏ö\n" +
        "‚Ä¢ /vibe ‚Äî ‡∏™‡∏∏‡πà‡∏°‡πÅ‡∏Ñ‡∏õ‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏î ‡πÜ\n" +
        "‚Ä¢ ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠ Newton / Tyra / Dream / Jisak ‡πÅ‡∏•‡πâ‡∏ß‡∏î‡∏π‡πÅ‡∏°‡πà‡πÄ‡∏°‡∏≤‡∏ó‡πå ü§≠"
    );
  });

  bot.onText(/^\/mode\s+(gentle|sassy|spicy)$/i, (msg, m) => {
    MODE = m[1].toLowerCase();
    const text =
      MODE === "gentle"
        ? "‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏™‡∏∏‡∏†‡∏≤‡∏û‡∏•‡∏∞‡∏à‡πâ‡∏∞ ‡∏ô‡∏∏‡πà‡∏°‡∏ô‡∏ß‡∏•‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡∏Ñ‡∏µ‡∏û‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏±‡∏á ‚ú®"
        : MODE === "spicy"
        ? "‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏ú‡πá‡∏î‡∏£‡πâ‡∏≠‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß‡∏à‡πâ‡∏≤ ‡∏£‡∏∞‡∏ß‡∏±‡∏á‡πÅ‡∏°‡πà‡∏ü‡∏≤‡∏î‡πÅ‡∏ö‡∏ö‡πÅ‡∏û‡∏á ‡πÜ üòò"
        : "‡πÇ‡∏´‡∏°‡∏î‡∏à‡∏£‡∏¥‡∏ï‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ñ‡πà‡∏∞‚Äî‡πÅ‡∏ã‡πà‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏µ üíÖ";
    bot.sendMessage(msg.chat.id, text);
  });

  bot.onText(/^\/vibe$/i, (msg) => {
    const vibes = [
      "‡πÄ‡∏á‡∏µ‡∏¢‡∏ö‡πÉ‡∏´‡πâ‡∏™‡∏∏‡∏î ‡∏Ñ‡∏°‡πÉ‡∏´‡πâ‡∏à‡∏≥ ‚öîÔ∏è",
      "‡πÑ‡∏°‡πà‡∏£‡∏±‡∏ö‡∏î‡∏£‡∏≤‡∏°‡πà‡∏≤ ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô üí∏",
      "‡πÅ‡∏û‡∏á‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏û‡∏π‡∏î‡πÄ‡∏¢‡∏≠‡∏∞ üñ§",
      "‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏ó‡∏±‡∏ô ‡πÉ‡∏à‡∏≠‡∏¢‡πà‡∏≤‡∏≠‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß",
      "‡∏ä‡∏ô‡∏∞‡πÄ‡∏á‡∏µ‡∏¢‡∏ö ‡πÜ ‡πÉ‡∏´‡πâ‡∏Ñ‡∏ô‡∏á‡∏á‡πÄ‡∏•‡πà‡∏ô ‚ú®",
    ];
    bot.sendMessage(msg.chat.id, pick(vibes));
  });

  bot.on("message", (msg) => {
    const text = (msg.text || "").trim();
    if (!text || text.startsWith("/")) return;

    // ‡∏•‡∏≥‡∏î‡∏±‡∏ö: ‡∏Ñ‡∏ô‡πÉ‡∏ô‡∏ó‡∏µ‡∏° -> ‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏ô‡∏ï‡πå -> ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ
    const p = replyPeople(text);
    const i = p ? null : replyIntent(text);
    const g = p || i || replyGeneral();
    bot.sendMessage(msg.chat.id, g);
  });
}

// -------- Health --------
app.get("/", (_, res) => {
  if (!TOKEN) {
    return res
      .status(200)
      .send("‚ùå Missing TELEGRAM_TOKEN ‚Äî ‡πÉ‡∏™‡πà‡πÅ‡∏•‡πâ‡∏ß Deploy ‡πÉ‡∏´‡∏°‡πà‡∏Ñ‡πà‡∏∞");
  }
  const mode = PUBLIC_URL ? "webhook" : "polling";
  res.status(200).send(`ElleBot Office live ‚úÖ (${mode})`);
});

// -------- Start server --------
app.listen(PORT, async () => {
  console.log(`HTTP on ${PORT}`);
  if (!TOKEN) return console.warn("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ TELEGRAM_TOKEN");
  try {
    if (PUBLIC_URL) await startWebhook();
    else await startPolling();
    attachHandlers();
  } catch (e) {
    console.error("Boot error (‡πÑ‡∏°‡πà‡∏•‡πâ‡∏°‡πÇ‡∏õ‡∏£‡πÄ‡∏ã‡∏™):", e?.message || e);
  }
});
